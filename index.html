<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Insurance Plan Simulator</title>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" />
      <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
   <script>
      "use strict";
      
      const card_template = '<div class="card mb-3"><header class="card-header is-shadowless"><p class="card-header-title">__header_text__</p><div class="card-header-icon" aria-label="more options" onclick="close_card()"><span class="icon"><i class="fas fa-times" aria-hidden="true"></i></span></div></header><div class="card-content"><div class="content">__body_text__</div></div></div>'

      function run_simulation(){
         var results = []
         results.push(simulate_premium());
         results.push(simulate_deductible());
         results.push(simulate_copay());
         results.push(simulate_coinsurance());
         results.push(simulate_oopm());
         
         if (hdhp_input.checked){
            results.push(simulate_hsa());
         }
         
         console.log(JSON.stringify(results, null, 2))
         
         var total = 0
         var result_text_html = ''
         results.forEach(function(result) {
            if (result['value'] > 0) {
               var display_number = '<span class="has-text-danger">$'+result['value'].toLocaleString()+'</span>'
               result_text_html += display_number + ' ' +result['text'] + '<br />'
            }
            
            if (result['value'] < 0) {
               var display_number = '<span class="has-text-success">$'+(result['value'] * -1 ).toLocaleString()+'</span>'
               result_text_html += display_number + ' ' +result['text'] + '<br />'
            }
            
            
            total += result['value']
         })
         
         var result_card = card_template
         result_card = result_card.replace('__header_text__', 'Total Spent for&nbsp; <u>'+visits_input.value+'</u> &nbsp;visits totaling&nbsp; <u>$'+parseInt(expenses_input.value).toLocaleString()+'</u>:&nbsp; <span class="has-text-info">$' + total.toLocaleString() + '</span>')
         result_card = result_card.replace('__body_text__', result_text_html)
         results_section.innerHTML += result_card;
         
         console.log(total)
      }

      function simulate_oopm(){
         var deductible = simulate_deductible()['value']
         var copay = simulate_copay()['value']
         var coinsurance = simulate_coinsurance()['value']
         var oopm = parseInt(oopm_input.value)
         
         var oop_due = deductible + copay + coinsurance
         
         if (oop_due > oopm ){
            return {
               'text': 'saved because out of pocket max reached',
               'value': oopm - oop_due
            }
         } else {
            return {
               'text': 'out of pocket max was not reached',
               'value': 0
            }
         }
         
      }

      function simulate_hsa(expenses){
         var deductible = simulate_deductible()['value']
         var copay = simulate_copay()['value']
         var coinsurance = simulate_coinsurance()['value']
         var oopm = parseInt(oopm_input.value)
         var tax_bracket = parseInt(tax_input.value) / 100
         
         var oop = deductible + copay + coinsurance
         
         if (oop > oopm ){
            oop = oopm
         }
         
         return {
            'text': 'offset by IRS deductions from HSA contributions',
            'value': tax_bracket * oop * -1
         }
      }
      
      function simulate_premium(){
         return {
            'text': 'spent on monthly premium',
            'value': parseInt(premium_input.value) * 12
         }
      }
      
      function simulate_deductible(){
         var expenses =  parseInt(expenses_input.value)
         var deductible = parseInt(deductible_input.value)

         var deductible_spent
         
         if (expenses >= deductible){
            deductible_spent = deductible
         } else {
            deductible_spent = expenses
         }
         
         
         return {
            'text': 'spent on deductable',
            'value': deductible_spent
         }
      }
      
      function simulate_copay(){
         return {
            'text': 'spent on copays',
            'value': parseInt(copay_input.value) * parseInt(visits_input.value)
         }
      }
      
      function simulate_coinsurance(){
         var deductible = parseInt(deductible_input.value)
         var expenses = parseInt(expenses_input.value)
         var coinsurance = parseInt(coinsurance_input.value)
         
         if (expenses <= deductible){
            return {
               'text': 'spent on coinsurance (deductable never met)',
               'value': 0
            }
         }

         return {
            'text': 'spent on coinsurance',
            'value': coinsurance/100 * (expenses - deductible)
         }
      }
      
      function check_hdhp(){
         if (parseInt(deductible_input.value) >= 1400) {
            hdhp_input.disabled = false
            tax_show()
         } else {
            hdhp_input.disabled = true
            hdhp_input.checked = false
            tax_show()
         }
      }

      function tax_show(){
         if (hdhp_input.checked) {
            tax_field.style.display = 'block';
            tax_input.required = true;
         } else {
            tax_field.style.display = 'none';
            tax_input.required = false;
         }
      }
      
      function close_card() {
         var to_delete = event.srcElement
         while (!to_delete.classList.contains('card')){
            to_delete = to_delete.parentElement
         }
         console.log(to_delete);
         to_delete.remove()
      }

      
   </script>
   </head>
   <body>
      <section class="hero">
         <div class="hero-body pt-2">
         
            <p class="title">
               Insurance Plan Simulator
            </p>

            <p class="subtitle">
               Insurance plan details go on the left, the simulation inputs go on the right
            </p>
            
            <form onSubmit="run_simulation(); return false;" class="columns">
               <div class="column">


                  <div class="field">
                     <label class="label">Monthly Premium ($)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="text" id="premium_input" value="456" placeholder="eg: 200" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-dollar-sign"></i>
                        </span>
                     </div>
                     <p class="help">The dollars payed for the insurance per month</p>
                  </div>

                  <div class="field">
                     <label class="label">Out of pocket maximum ($)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="text" id="oopm_input" value="8200" placeholder="eg: 2000" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-dollar-sign"></i>
                        </span>
                     </div>
                     <p class="help">The maximum out of pocket total for the insurance plan</p>
                  </div>

                  <div class="field">
                     <label class="label">Deductible ($)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="text" id="deductible_input" onchange="check_hdhp()" value="1400" placeholder="eg: 1000" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-dollar-sign"></i>
                        </span>
                     </div>
                     <label class="checkbox">
                        <input type="checkbox" checked onchange="tax_show()" id="hdhp_input">
                        This is an IRS qualified High Deductible Health Plan
                     </label>
                  </div>


                  <div class="field">
                     <label class="label">Coinsurance (%)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="text" value="20" id="coinsurance_input" placeholder="eg: 30" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-percent"></i>
                        </span>
                     </div>
                     <p class="help">The percentage you pay after the deductible before the oopm</p>
                  </div>

                  <div class="field">
                     <label class="label">Copay ($)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="text" value="30" id="copay_input" placeholder="eg: 30" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-dollar-sign"></i>
                        </span>
                     </div>
                     <p class="help">The per-office-visit copay</p>
                  </div>

                  <div class="field" id='tax_field'>
                     <label class="label">Tax Bracket (%)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="number" value="32" min="10" max="37" id="tax_input" placeholder="eg: 24" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-percent"></i>
                        </span>
                     </div>
                     <p class="help">Your <a target="_blank" href="https://taxfoundation.org/2021-tax-brackets/">federal tax bracket</a> as a percent to calculate HSA refund for HDHP</p>
                  </div>

                  <div class="pt-3">
                     This tool provided for free by <a href='https://tier2.tech' target='_blank'>Tier2 Technologies</a>.<br />
                     If you find it useful, then please tell the IT person at your office about our flagship product: <a target="_blank" href="https://www.tier2tickets.com/">Tier2Tickets</a>
                     <p class="has-text-grey">
                        © 2021 Tier2 Technologies | All Rights Reserved
                     </p>
                  </div>

               </div>

               <div class="column">

                  <div class="field">
                     <label class="label">Visit Count (#)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="text" value="12" id="visits_input" placeholder="eg: 12" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-hashtag"></i>
                        </span>
                     </div>
                     <p class="help">Number of office visits to simulate for a year</p>
                  </div>

                  <div class="field">
                     <label class="label">Annual Total Medical Expenses ($)</label>
                     <div class="control has-icons-left has-icons-right">
                        <input class="input" required pattern="[0-9]+" title="whole numbers only" type="text" id="expenses_input" value="5000" placeholder="eg: 12" />
                        <span class="icon is-small is-left">
                           <i class="fas fa-dollar-sign"></i>
                        </span>
                     </div>
                     <p class="help">Total annual medical expenses to simulate</p>
                  </div>
                  
                  <button class="button is-success">Run Simulation</button>
                  
                  <section class="section" id="results_section">
                  </section>
                  

               </div>
            </form>
         </div>
      </section>
   </body>
</html>
